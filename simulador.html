<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßü El √öltimo Refugio - Defensa</title>
    <style>
        /* --- Estilos CSS (Iguales a la versi√≥n anterior, con colores para Materiales) --- */
        body { 
            font-family: 'Consolas', monospace; 
            margin: 0; 
            background-color: #333; 
            color: #eee;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container { 
            max-width: 800px; 
            width: 100%;
            background: #222; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); 
            border: 2px solid #880000;
        }
        h1 { 
            color: #ff4444; 
            text-align: center; 
            border-bottom: 2px solid #880000;
            padding-bottom: 10px;
        }
        h2 { color: #ff8888; }
        .stats, .controls { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px dashed #666; 
            border-radius: 5px; 
            background-color: #2a2a2a;
        }
        .stats div { margin-bottom: 8px; }
        label { display: block; margin-top: 10px; }
        select, input[type="number"] {
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #333;
            color: white;
            width: 100%;
            box-sizing: border-box;
        }
        button { 
            padding: 12px 20px; 
            background-color: #007700; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 15px;
            width: 100%;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #005500; }
        #log { 
            margin-top: 20px; 
            padding: 10px; 
            background-color: #1a1a1a; 
            border-radius: 4px; 
            height: 200px; 
            overflow-y: scroll; 
            border: 1px solid #444;
        }
        #log p { margin: 5px 0; font-size: 0.9em; line-height: 1.2; }
        .win { color: #00ff00; font-weight: bold; }
        .loss { color: #ff0000; font-weight: bold; }
        .warning { color: #ffaa00; }
        .success { color: #00ffaa; }
        .danger { color: #ff4444; }
        .material { color: #9999ff; } /* Color para Materiales */
    </style>
</head>
<body>
    <div class="container">
        <h1>üßü El √öltimo Refugio: Simulaci√≥n Zombie</h1>
        
        <div class="stats">
            <h2>üè† Estado del Refugio (D√≠a <span id="dayCount">1</span>)</h2>
            <div>Supervivientes: <strong id="survivorCount">3</strong></div>
            <div>Comida: <strong id="foodCount">10</strong></div>
            <div>Medicinas: <strong id="medsCount">5</strong></div>
            <div>Materiales: <strong id="materialCount" class="material">5</strong></div> 
            <div>Nivel de Defensa: <strong id="defenseLevel">1</strong> (Costo prox. 5 Materiales)</div>
            <div>Horda Zombie (Proximidad): <strong id="hordeSize">20</strong></div>
        </div>
        
        <div class="controls">
            <h2>üß± Gesti√≥n de la Defensa</h2>
            <button onclick="upgradeDefense()">üõ†Ô∏è Mejorar Defensa (Costo: 5 Materiales)</button>
        </div>
        
        <div class="controls">
            <h2>üó∫Ô∏è Expedici√≥n del D√≠a</h2>
            <label for="destination">Destino:</label>
            <select id="destination">
                <option value="suburbios">Suburbios (Riesgo 20%, Comida/Materiales)</option>
                <option value="hospital">Hospital (Riesgo 40%, Medicina)</option>
                <option value="ciudad">Ciudad (Riesgo 60%, Varios)</option>
            </select>
            
            <label for="teamSize">Miembros del Equipo:</label>
            <input type="number" id="teamSize" value="1" min="0" max="3" oninput="updateAvgAbility()">
            <small>Habilidad Promedio: <span id="avgAbility">7</span></small>
            
            <button onclick="startDay()">‚è© INICIAR D√çA Y EXPEDICI√ìN</button>
        </div>
        
        <div id="log">
            <p><strong>Registro de Eventos:</strong></p>
        </div>
    </div>

    <script>
        // --- 1. Variables de Estado Inicial (A√±adimos Materiales) ---
        let state = {
            day: 1,
            survivors: 3,
            food: 10,
            meds: 5,
            materials: 5, // Nuevo Recurso: Materiales
            defense: 1,
            horde: 20,
            baseAbility: 7,
            DEFENSE_COST: 5 // Costo fijo para mejorar la defensa
        };

        const log = document.getElementById('log');
        let gameOver = false;

        // --- 2. Funciones de la Interfaz y Utilidad ---

        function updateUI() {
            document.getElementById('dayCount').textContent = state.day;
            document.getElementById('survivorCount').textContent = state.survivors;
            document.getElementById('foodCount').textContent = state.food;
            document.getElementById('medsCount').textContent = state.meds;
            document.getElementById('materialCount').textContent = state.materials; // Mostrar Materiales
            document.getElementById('defenseLevel').textContent = state.defense;
            document.getElementById('hordeSize').textContent = state.horde;
            document.getElementById('teamSize').max = state.survivors;
            document.querySelector('.controls button[onclick="upgradeDefense()"]').textContent = `üõ†Ô∏è Mejorar Defensa (Costo: ${state.DEFENSE_COST} Materiales)`;
            updateAvgAbility();
        }

        function updateAvgAbility() {
            document.getElementById('avgAbility').textContent = state.baseAbility;
        }

        function addLog(message, className = '') {
            const entry = document.createElement('p');
            entry.innerHTML = `<span class="${className}">[D√≠a ${state.day}] ${message}</span>`;
            log.prepend(entry);
        }

        function rollDice(chance) {
            return Math.random() * 100 < chance;
        }

        // --- 3. NUEVA L√ìGICA DE DEFENSA ---

        function upgradeDefense() {
            if (gameOver) {
                addLog("El juego ha terminado.", 'warning');
                return;
            }

            if (state.materials >= state.DEFENSE_COST) {
                state.materials -= state.DEFENSE_COST;
                state.defense++;
                // Aumentar el costo de la pr√≥xima mejora para progresar
                state.DEFENSE_COST += 2; 

                addLog(`üß± **¬°Defensa Mejorada!** Nivel de Defensa actual: ${state.defense}.`, 'material');
            } else {
                addLog(`‚ö†Ô∏è **No hay suficientes Materiales.** Necesitas ${state.DEFENSE_COST} para mejorar.`, 'warning');
            }
            updateUI();
        }

        // --- 4. L√≥gica Principal del Juego (startDay) ---

        function startDay() {
            if (gameOver) {
                addLog("El juego ha terminado. Recarga para empezar de nuevo.", 'loss');
                return;
            }

            // 1. Fase de Mantenimiento y Consumo
            resolveMaintenance();

            // 2. Fase de Expedici√≥n
            resolveExpedition();

            // 3. Fase Nocturna (Asalto Zombie)
            resolveNightAttack();

            // 4. Avance del D√≠a
            state.day++;
            state.horde += Math.floor(Math.random() * 5) + 1; 

            // 5. Comprobar Victoria/Derrota
            checkGameOver();
            
            updateUI();
        }

        function resolveMaintenance() {
            // Consumo de Comida
            if (state.food < state.survivors) {
                state.food = 0;
                state.baseAbility = Math.max(1, state.baseAbility - 1); 
                addLog(`‚ö†Ô∏è **¬°Hambre!** No hay suficiente comida. La Habilidad base ha bajado.`, 'warning');
            } else {
                state.food -= state.survivors;
            }
        }

        function resolveExpedition() {
            const destination = document.getElementById('destination').value;
            const teamSize = parseInt(document.getElementById('teamSize').value);
            const ability = state.baseAbility;

            if (teamSize <= 0) {
                addLog("El equipo se queda en el refugio. No se realiz√≥ ninguna b√∫squeda.");
                return;
            }
            if (teamSize > state.survivors) {
                 addLog("‚õî No hay suficientes supervivientes disponibles para esa misi√≥n.", 'danger');
                 return;
            }

            let riskBase = 0;
            let rewardType = '';

            switch (destination) {
                case 'suburbios': riskBase = 20; rewardType = 'Comida_Materiales'; break;
                case 'hospital': riskBase = 40; rewardType = 'Medicinas'; break;
                case 'ciudad': riskBase = 60; rewardType = 'Varios'; break;
            }

            // --- 4A. √âXITO DE B√öSQUEDA ---
            const successChance = (ability * 5) * (teamSize / state.survivors);
            
            if (rollDice(successChance)) {
                const baseLoot = Math.floor(Math.random() * 5) + teamSize; 
                
                // Distribuci√≥n del nuevo bot√≠n (incluyendo materiales)
                if (rewardType === 'Comida_Materiales') { 
                    state.food += baseLoot;
                    state.materials += Math.floor(baseLoot * 1.5); // Suburbios da m√°s materiales
                    addLog(`‚úÖ **√âxito** en ${destination}. Se encontraron ${baseLoot} de comida y ${Math.floor(baseLoot * 1.5)} de materiales.`, 'success');
                } else if (rewardType === 'Medicinas') { 
                    state.meds += baseLoot;
                    state.materials += Math.floor(baseLoot / 2); // Poco material
                    addLog(`‚úÖ **√âxito** en ${destination}. Se encontraron ${baseLoot} de medicinas.`, 'success');
                } else { // Varios (Ciudad)
                    state.food += Math.floor(baseLoot / 2); 
                    state.meds += Math.floor(baseLoot / 4); 
                    state.materials += baseLoot;
                    addLog(`‚úÖ **√âxito** en ${destination}. Se encontraron recursos varios.`, 'success');
                }
            } else {
                addLog(`‚ùå El equipo en ${destination} no encontr√≥ nada √∫til.`);
            }

            // --- 4B. RIESGO DE ENCUENTRO ZOMBIE ---
            const encounterChance = riskBase + (state.horde / 10);
            
            if (rollDice(encounterChance)) {
                addLog(`üö® **¬°Encuentro Zombie!** El equipo fue emboscado en ${destination}.`, 'danger');
                
                // --- 4C. C√ÅLCULO DE SUPERVIVENCIA ---
                const localHordeSim = teamSize * 3; 
                const survivalChance = Math.max(10, (ability * 10) - localHordeSim); 
                const lossChance = 100 - survivalChance;

                if (rollDice(lossChance)) {
                    state.survivors--;
                    addLog(`üíÄ **¬°P√©rdida Cr√≠tica!** Un superviviente no regres√≥ de la expedici√≥n.`, 'loss');
                } else {
                    addLog("üí™ El equipo luch√≥ con √©xito y logr√≥ escapar.", 'success');
                }
            }
        }

        function resolveNightAttack() {
            // PROBABILIDAD DE ASALTO
            // La defensa reduce la probabilidad de asalto
            const attackChance = Math.max(0, (state.horde / 5) - (state.defense * 2)); 
            
            if (rollDice(attackChance)) {
                addLog(`üí• **¬°ASALTO ZOMBIE!** La horda est√° atacando el refugio.`, 'danger');
                
                // Probabilidad de que la defensa AGUANTE: Nivel de Defensa * 15%
                if (rollDice(state.defense * 15)) {
                    addLog(`üõ°Ô∏è **¬°Defensa Exitosa!** El refugio de Nivel ${state.defense} repeli√≥ el asalto.`, 'success');
                } else {
                    // Defensa Fallida
                    const lostFood = Math.floor(Math.random() * 3) + 1;
                    state.food = Math.max(0, state.food - lostFood);
                    addLog(`üî• La defensa fall√≥. Se perdieron ${lostFood} de comida.`, 'warning');

                    if (rollDice(20)) { 
                         state.survivors--;
                         addLog(`üíÄ Un superviviente fue arrastrado durante el asalto.`, 'loss');
                    }
                }
            } else {
                addLog(`üåô Noche tranquila. El Nivel de Defensa ${state.defense} mantuvo a la horda a raya.`);
            }
        }

        function checkGameOver() {
            if (state.survivors <= 0) {
                addLog("üí• **FIN DEL JUEGO:** Todos los supervivientes han muerto. El refugio ha ca√≠do.", 'loss');
                gameOver = true;
            } else if (state.day >= 50 && !gameOver) { 
                addLog("üéâ **¬°VICTORIA!** Has sobrevivido 50 d√≠as y has encontrado un equipo de rescate.", 'win');
                gameOver = true;
            }
        }

        // Inicializar el juego al cargar
        window.onload = function() {
            updateUI();
            addLog("El √öltimo Refugio. ¬°Sobrevive 50 d√≠as! Usa Materiales para mejorar tu Defensa.", 'success');
        };
    </script>
</body>
</html>